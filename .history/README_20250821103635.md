# Endotheliosis Quantifier

Automated quantification of glomerular endotheliosis on H&E slides. This repository provides a reproducible pipeline for segmentation, feature extraction, and quantification, with a Python package layout under `src/eq` and tests under `tests/`.

## Contents
- Overview
- Installation
- Data layout
- Quickstart
- Package usage
- Development and testing
- Troubleshooting (Apple Silicon)

## Overview
The pipeline segments glomeruli and computes quantitative metrics related to glomerular endotheliosis. It is designed for reproducibility and clarity: reusable modules live in `src/eq`, thin CLI wrappers live under `scripts/`, and tests validate behavior on small real data slices.

## Installation
Clone the repository:
```bash
git clone https://github.com/nicholas-camarda/endotheliosis_quantifier.git
cd endotheliosis_quantifier
```

Create or update the environment (mamba recommended):
```bash
mamba env create -f environment.yml  # first time
# or, to update an existing env named eq
mamba env update -f environment.yml --prune
```

Activate the environment:
```bash
mamba activate eq  # if your shell is configured for mamba
# otherwise, standard activation still works:
conda activate eq
```

## Data layout
Expected data directories (verified by `scripts/utils/runtime_check.py`):
- `data/Lauren_PreEclampsia_Data/train/images`
- `data/Lauren_PreEclampsia_Data/train/masks`
- `data/Lauren_PreEclampsia_Data/train/rois`
- `data/Lauren_PreEclampsia_Data/cache`

If these do not exist, place or link your data accordingly.

## Quickstart
Verify your environment and data:
```bash
mamba run -n eq python scripts/utils/runtime_check.py
```

Run a smoke test of the pipeline (minimal):
```bash
mamba run -n eq python scripts/utils/smoke_test_pipeline.py
```

Train or run segmentation (example wrappers may vary by use-case):
```bash
mamba run -n eq python scripts/main/1_load_data_for_segmentation_analysis.py
mamba run -n eq python scripts/main/2_train_glomeruli_segmenter.py
```

## Package usage
Import reusable modules from `eq.*` in your own scripts or notebooks:
```python
from eq.patches.patchify_images import patchify_images
from eq.features.preprocess_roi import preprocess_roi

tiles = patchify_images('/path/to/images', tile_size=256, stride=128)
processed = preprocess_roi('/path/to/rois')
```

## Development and testing
Install developer tools (optional; see `pyproject.toml` extras):
```bash
mamba run -n eq python -m pip install -e .[dev]
```

Run tests:
```bash
python tests/test_env.py
python tests/test_docs.py
```

Code style and linting (ruff):
```bash
mamba run -n eq ruff format .
mamba run -n eq ruff check .
```

## Troubleshooting (Apple Silicon)
This project uses the Apple Silicon TensorFlow stack (`tensorflow-macos` + `tensorflow-metal`) by default. If you are on Linux with CUDA, replace those with a compatible `tensorflow>=2.10` and install CUDA/CuDNN per NVIDIAâ€™s guidance.

If you encounter import errors or missing frameworks, re-run the environment update step and the runtime check.
