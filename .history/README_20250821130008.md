# Endotheliosis Quantifier

A Python package for quantifying endotheliosis in kidney tissue images using machine learning and computer vision techniques.

## Overview

This project provides tools for:
- ROI (Region of Interest) extraction from kidney tissue images
- Feature extraction using deep learning models
- Endotheliosis quantification and scoring
- Data preprocessing and augmentation

## Environment Setup

This project standardizes on a Conda environment named `eq` as defined in `environment.yml`.

### Installation

Create or update the environment (using mamba):

```bash
mamba env create -f environment.yml  # first time
# or, to update an existing env named eq
mamba env update -f environment.yml --prune
```

Activate the environment:

```bash
mamba activate eq  # if your shell is configured for mamba
# otherwise, standard activation still works:
conda activate eq
```

### Dependencies

Install additional dependencies:

```bash
# Install geos for spatial operations
brew install geos

# Install HistomicsTK
git clone https://github.com/DigitalSlideArchive/HistomicsTK/
cd HistomicsTK
python setup.py install
python setup.py build_ext --inplace

# Install PyTorch and related packages
pip install torch torchvision segmentation-models-pytorch ipykernel matplotlib albumentations --force-reinstall --no-cache-dir
pip install ipywidgets jupyter docker -U

# Install OpenSlide
conda install openslide
```

## Using the eq Package

The project has been migrated to use a structured Python package under `src/eq/`. You can now use the package functions directly:

### Basic Usage

```python
# Run ROI extraction using the eq package
from eq.features.preprocess_roi import preprocess_images
preprocess_images('data/preeclampsia_data/train/images', 
                 'data/preeclampsia_data/train/masks', 
                 'output/rois')

# Run feature extraction
from eq.features.helpers import extract_features
features = extract_features(images)

# Run endotheliosis quantification
from eq.pipeline.quantify_endotheliosis import load_pickled_data, run_random_forest
# ... use the functions as needed
```

### Package Structure

- `eq.features.helpers` - Core feature extraction and processing functions
- `eq.features.preprocess_roi` - ROI preprocessing with circular extraction
- `eq.pipeline.quantify_endotheliosis` - Endotheliosis quantification pipeline
- `eq.io.convert_files_to_jpg` - File format conversion utilities
- `eq.patches.patchify_images` - Image patching utilities
- `eq.augment.augment_dataset` - Data augmentation functions

## Data

### Downloading Data

You can download the AIDPATH dataset from their website (https://aidpath.org/data/) or access it through their API. You will need to create an account to access the data.

### Data Structure

The project expects data in the following structure:

```
data/preeclampsia_data/
├── train/
│   ├── images/     # Training images
│   ├── masks/      # Corresponding masks
│   └── rois/       # Extracted ROIs
└── cache/          # Cached features and scores
```

## Development

### Running Tests

```bash
# Run all tests
mamba run -n eq python -m pytest tests/ -v

# Run specific test categories
mamba run -n eq python -m pytest tests/test_docs.py -v
mamba run -n eq python -m pytest tests/test_imports.py -v
```

### Code Quality

```bash
# Run linting
mamba run -n eq ruff check .

# Run formatting
mamba run -n eq ruff format .
```

## Repository

This project is hosted at: https://github.com/nicholas-camarda/endotheliosis_quantifier.git

## License

See LICENSE file for details.

