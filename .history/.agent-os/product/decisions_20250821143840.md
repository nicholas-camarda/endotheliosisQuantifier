# Decisions Log

## Platform & Performance
- Must run on macOS Apple Silicon (M1) for inference and light workflows.
- Retain optional Windows (WSL2) + CUDA path (RTX 3080) for training; document when required.

## Framework
- **DECISION**: Use fastai/PyTorch for dual-environment architecture (M1 Mac/Metal and RTX 3080/CUDA).
- Migrate from TensorFlow/Keras to fastai/PyTorch for improved cross-platform developer experience.

## Packaging & Structure
- Rename repository to `endotheliosis_quantifier`.
- Adopt `src/eq` package with CLI entrypoints for the 4 pipeline steps.
- Centralize configuration; remove hard-coded paths.

## Reproducibility & Standards
- Use Conda env `eq` exclusively for installs/execution.
- Follow `.agent-os/standards/code-style/python-style.md`.
- Separate test scripts for new/updated logic; assert specific outputs on test data.

## 2025-01-27: Framework Migration to fastai/PyTorch
**ID:** DEC-003
**Status:** Accepted
**Category:** technical

### Decision
- Migrate from TensorFlow/Keras to fastai/PyTorch for the dual-environment architecture.
- Implement explicit mode selection between production (RTX 3080/CUDA) and development (M1 Mac/Metal) workflows.
- Use fastai's high-level API with PyTorch backend for seamless cross-platform support.

### Context
- User has proven success with fastai/PyTorch for segmentation tasks
- PyTorch provides better support for both CUDA (RTX 3080) and MPS (Apple Silicon)
- Fastai offers higher-level API that works seamlessly across both backends
- TensorFlow's Metal support has been problematic historically
- Aligns with dual-environment architecture requirements in spec

### Implementation
- Update environment.yml to use fastai/PyTorch dependencies
- Migrate segmentation training code from TensorFlow to fastai
- Implement hardware detection and mode selection system
- Update CLI interface to support explicit mode selection

## 2025-08-21: Repository Hygiene and Utilities Consolidation
**ID:** DEC-001
**Status:** Accepted
**Category:** technical

### Decision
- Consolidate `scripts/utils/` to a minimal, well-documented helper set; remove or merge redundant utilities.
- Do not track large/ephemeral folders: `notebooks/`, `earlier_models/`. Update `.gitignore` accordingly.

### Context
Improves maintainability, reduces confusion for users, and avoids committing bulky, non-source artifacts. Aligns with packaging goals and cross-platform reproducibility.

## 2025-01-27: CLI Pipeline System Implementation
**ID:** DEC-002
**Status:** Accepted
**Category:** technical

### Decision
- Implement comprehensive CLI pipeline system with `eq` command and subcommands for each pipeline step.
- Use `src/eq/__main__.py` as the main CLI entry point with argparse-based command parsing.
- Create wrapper functions in each module to handle CLI arguments and orchestrate pipeline steps.
- Install package in development mode with console script entry point.

### Commands Implemented
- `eq data-load` - Load and preprocess data with configurable paths
- `eq train-segmenter` - Train segmentation models with hyperparameter control
- `eq extract-features` - Extract features from images using trained models
- `eq quantify` - Run endotheliosis quantification pipeline
- `eq pipeline` - Execute complete end-to-end pipeline

### Context
Provides a centralized, user-friendly interface for running the endotheliosis quantification pipeline. Eliminates the need for users to understand internal module structure or manually orchestrate pipeline steps. Enables both step-by-step execution and full pipeline runs with consistent parameter handling.
