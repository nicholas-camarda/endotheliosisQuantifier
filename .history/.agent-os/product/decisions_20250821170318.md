# Decisions Log

## Platform & Performance
- Must run on macOS Apple Silicon (M1) for inference and light workflows.
- Retain optional Windows (WSL2) + CUDA path (RTX 3080) for training; document when required.

## Framework
- **DECISION MADE 2025-08-21**: Migrate to fastai/PyTorch for all segmentation and training workflows.
- Leverage existing working fastai implementations from notebooks folder.
- Use PyTorch with MPS (Metal Performance Shaders) for Apple Silicon and CUDA for RTX 3080.
- This provides superior cross-platform support and leverages proven working code.

## Packaging & Structure
- Rename repository to `endotheliosis_quantifier`.
- Adopt `src/eq` package with CLI entrypoints for the 4 pipeline steps.
- Centralize configuration; remove hard-coded paths.

## Reproducibility & Standards
- Use Conda env `eq` exclusively for installs/execution.
- Follow `.agent-os/standards/code-style/python-style.md`.
- Separate test scripts for new/updated logic; assert specific outputs on test data.

## 2025-08-21: Repository Hygiene and Utilities Consolidation
**ID:** DEC-001
**Status:** Accepted
**Category:** technical

### Decision
- Consolidate `scripts/utils/` to a minimal, well-documented helper set; remove or merge redundant utilities.
- Do not track large/ephemeral folders: `notebooks/`, `earlier_models/`. Update `.gitignore` accordingly.

### Context
Improves maintainability, reduces confusion for users, and avoids committing bulky, non-source artifacts. Aligns with packaging goals and cross-platform reproducibility.

## 2025-01-27: CLI Pipeline System Implementation
**ID:** DEC-002
**Status:** Accepted
**Category:** technical

### Decision
- Implement comprehensive CLI pipeline system with `eq` command and subcommands for each pipeline step.
- Use `src/eq/__main__.py` as the main CLI entry point with argparse-based command parsing.
- Create wrapper functions in each module to handle CLI arguments and orchestrate pipeline steps.
- Install package in development mode with console script entry point.

### Commands Implemented
- `eq data-load` - Load and preprocess data with configurable paths
- `eq train-segmenter` - Train segmentation models with hyperparameter control
- `eq extract-features` - Extract features from images using trained models
- `eq quantify` - Run endotheliosis quantification pipeline
- `eq pipeline` - Execute complete end-to-end pipeline

### Context
Provides a centralized, user-friendly interface for running the endotheliosis quantification pipeline. Eliminates the need for users to understand internal module structure or manually orchestrate pipeline steps. Enables both step-by-step execution and full pipeline runs with consistent parameter handling.

## 2025-01-27: fastai/PyTorch Migration Decision
**ID:** DEC-003
**Status:** Completed
**Category:** framework

### Decision
- **COMPLETED**: Full migration from TensorFlow to fastai/PyTorch for all segmentation and training workflows.
- **COMPLETED**: TensorFlow packages completely removed from environment to eliminate conflicts.
- Convert existing working notebook implementations to production-ready Python modules.
- Implement dual-environment architecture with explicit mode selection between development (M1 Mac/MPS) and production (RTX 3080/CUDA).
- Use PyTorch's native MPS support for Apple Silicon and CUDA for NVIDIA GPUs.

### Rationale
- Existing fastai implementations in notebooks are proven and working
- PyTorch provides superior cross-platform support with native MPS and CUDA backends
- fastai offers higher-level API that works seamlessly across both backends
- **RESOLVED**: Eliminated TensorFlow Metal compatibility issues and OpenMP conflicts
- Leverages existing developer expertise and working code

### Implementation Progress
1. ✅ **COMPLETED**: Updated environment dependencies from TensorFlow to fastai/PyTorch
2. ✅ **COMPLETED**: Removed all TensorFlow packages (tensorflow-macos, tensorflow-metal, tensorflow-hub, tensorflow-estimator)
3. ✅ **COMPLETED**: Implemented comprehensive hardware detection and mode selection system
4. ✅ **COMPLETED**: Created dual-environment architecture foundation with 42 passing tests
5. ✅ **COMPLETED**: Convert working notebook implementations to Python modules (68 passing tests)
6. ✅ **COMPLETED**: Implemented dual-environment architecture with mode selection and backend abstraction (117 passing tests)
7. ✅ **COMPLETED**: CLI pipeline updated to support dual-environment architecture with mode selection and hardware detection
8. ✅ **COMPLETED**: Full TensorFlow to fastai migration completed with comprehensive test coverage (162 passing tests)

### 2025-08-21: Production Heuristic Tightening
- **Change**: Production mode is now only suggested/valid on CUDA systems, or on Apple Silicon (MPS) with ≥32GB unified memory.
- **Rationale**: Typical M1/M2 8-16GB machines are excellent for development/inference but underpowered for sustained production training.
- **Effect**:
  - AUTO will default to DEVELOPMENT on M1 with <32GB.
  - Validation rejects PRODUCTION on CPU-only or MPS <32GB; users can still explicitly choose DEVELOPMENT.

### Context
This decision addresses the dual-environment architecture requirements while leveraging existing working implementations. The fastai/PyTorch approach provides better cross-platform compatibility and has eliminated the TensorFlow Metal issues that were previously encountered. Environment is now clean with no TensorFlow conflicts.

## 2025-08-21: TensorFlow to fastai Migration Completion
**ID:** DEC-004
**Status:** Completed
**Category:** framework

### Decision
- **COMPLETED**: Successfully migrated entire segmentation system from TensorFlow to fastai/PyTorch
- **COMPLETED**: Created comprehensive fastai segmentation module with U-Net support and mode-specific optimizations
- **COMPLETED**: Implemented advanced data pipeline with cache integration and augmentation
- **COMPLETED**: Added mode-specific training strategies (production, development, auto) with hardware-aware optimization
- **COMPLETED**: Comprehensive test coverage with 46 fastai segmentation tests and 162 total tests passing

### Implementation Details
1. **FastaiSegmenter Class**: Complete segmentation implementation with multiple U-Net architectures (ResNet18, 34, 50, 101)
2. **Data Pipeline**: Enhanced data preparation with support for cached pickle files and advanced augmentation
3. **Training Strategies**: Mode-specific training with production (conservative), development (aggressive), and auto (balanced) approaches
4. **Hardware Integration**: Automatic device selection (MPS/CUDA/CPU) with optimal batch sizing and mode validation
5. **Callback System**: Comprehensive monitoring with early stopping, learning rate scheduling, and model checkpointing
6. **Migration Script**: Created `train_segmenter_fastai.py` as drop-in replacement for TensorFlow implementation

### Benefits Achieved
- **Modern Stack**: Replaced TensorFlow with fastai/PyTorch for superior cross-platform support
- **M1 Optimization**: Native MPS acceleration for Apple Silicon with automatic fallback
- **Training Efficiency**: Mode-specific optimizations and advanced augmentation pipeline
- **Maintainability**: Comprehensive test suite (46 tests) ensuring reliability
- **Hardware Awareness**: Automatic detection and optimization for different configurations
- **Backward Compatibility**: Maintains existing data format and CLI interface

### Context
This migration completes the framework transition decision and provides a production-ready fastai segmentation system. The implementation leverages existing working notebook code while adding enterprise-grade features like mode-specific training, hardware optimization, and comprehensive testing. All 162 tests pass, confirming the migration's success and system stability.
